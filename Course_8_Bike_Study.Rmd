---
title: "Course_8_Bike_Study"
author: "Colin Coyne - Coyne Operations Ltd"
date: "`r Sys.Date()`"
output: html_document
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Chunk output can be customized with knitr options, arguments set in the {} of 
# a chunk header. Above, we use five arguments:

# include = FALSE prevents code and results from appearing in the finished file.
# R Markdown still runs the code in the chunk, and the results can be used by 
# other chunks.

# echo = FALSE prevents code, but not the results from appearing in the 
# finished file. This is a useful way to embed figures.

# message = FALSE prevents messages that are generated by code from appearing 
# in the finished file.

# warning = FALSE prevents warnings that are generated by code from appearing 
# in the finished.

# fig.cap = "..." adds a caption to graphical results.
```

# R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:
  
# Analyse dataset

## Please note: 
#  MY PC DATA path: "C:/Users/User/OneDrive/00_Data Analytics and Analysis/Course 8 - Data Analytics Capstone Complete a Case Study/Bike Data/"

#  KAGGLE INPUT directory is   ../input/tripdata/all_tripdata.csv
#  KAGGLE OUTPUT directory is  /kaggle/working

```{r Set_Working_Directories, message = FALSE, warning = FALSE}
#Input_Dir <- "../input/tripdata"   # for KAGGLE
#Output_Dir <- "/kaggle/working"    # for KAGGLE

Input_Dir <- "C:/Users/User/OneDrive/00_Data Analytics and Analysis/Course 8 - Data # Analytics Capstone Complete a Case Study/Bike Data"
Output_Dir <- "C:/Users/User/OneDrive/00_Data Analytics and Analysis/Course 8 - # Data Analytics Capstone Complete a Case Study/Bike Data"

# Set the path to the working directory
# setwd(Input_Dir) # set working directory
getwd()          # show working directory
Input_Dir        # show INPUT directory
Output_Dir       # show OUTPUT directory

#myfile <- paste(Input_Dir,"small-divvy-tripdata.csv", sep = "/")
#myfile

```

## Install and load necessary packages and libraries

```{r Load_Packages_and_Libraries, message = FALSE, warning = FALSE}
if(!require(tidyVerse)) install.packages("tidyverse",repos = "http://cran.us.r-project.org")
library(tidyverse)            # load required library

if(!require(ggplot2)) install.packages("ggplot2",repos = "http://cran.us.r-project.org")
library(ggplot2)       # load required library

if(!require(lubridate)) install.packages("lubridate",repos = "http://cran.us.r-project.org")
library(lubridate)

if(!require(dplyr)) install.packages("dplyr",repos = "http://cran.us.r-project.org")
library(dplyr)

# Used to determine DISTANCE between Long/Lat Start and End Points
# Will NOT be used in this analysis
#if(!require(geosphere)) install.packages("geosphere",repos = #"http://cran.us.r-project.org")
#library(geosphere)

if(!require(sf)) install.packages("sf",repos = "http://cran.us.r-project.org")
library(sf)

if(!require(mapview)) install.packages("mapview",repos = "http://cran.us.r-project.org")
library(mapview)

library(readr)
```

# Import / Load required CSV data files into R studio

I ensured that the data sets have the same number of columns and same column names before going forward to merge them, I also checked for inconsistencies

```{r Load_CSV}
# If loading 12 individual monthly data sets into frames and then merging into 
# a large data frame, use the command ... 

# tripdata_df <- bind_rows(feb21, mar21, apr21, may21, jun21, jul21, aug21, 
# sep21, oct21, nov21, dec21, jan22)

# create a dataframe containing required dataset
# library(readr)

# Small dataset to test cleansing
# myfile <- paste(Input_Dir,"small-divvy-tripdata.csv", sep = "/")

# small data set for testing
# myfile <- paste(Input_Dir,"202201-divvy-tripdata.csv", sep = "/")

# small data set for testing
# myfile <- paste(Input_Dir,"202112-divvy-tripdata.csv", sep = "/")

# Load FULL dataset (all months)
myfile <- paste(Input_Dir,"all_tripdata.csv", sep = "/")

# load required dataset 
tripdata_df <- read_csv(myfile)

head(tripdata_df)
View(tripdata_df)

Ride_Count = length(unique(tripdata_df$ride_id))
View(Ride_Count)   # Count of unique ride_id's

# Alternative location for dataset
# tripdata_df <- read_csv("all_tripdata.csv")

# View(tripdata_df)    # view / validate data
head(tripdata_df)      # view top of dataset
colnames(tripdata_df)  # view column names of dataset
str(tripdata_df)       # see structure and record count of dataset
```

# To test validity of data loaded ... the following code chunks were used 

head(tripdata_df)     #   see the first 6 rows of the data frame
nrow(tripdata_df)     #   how many rows are in the data frame
colnames(tripdata_df) #   list of column names
dim(tripdata_df)      #   dimensions of the data frame
summary(tripdata_df)  #   statistical summary of data, mainly for numerics
str(tripdata_df)      #   see list of columns and data types
tail(tripdata_df)     #   see the last 6 rows of the data frame

# Get overview summarys of trip info (before cleanse)

Adding columns for date, month, year, day of the week into the data frame.

trip_data$date <- as.Date(tripdata_df$started_at) 
trip_data$month <- format(as.Date(tripdata_df$date), "%m")
trip_data$day <- format(as.Date(tripdata_df$date), "%d")
trip_data$year <- format(as.Date(trip_data$date), "%Y")
trip_data$day_of_week <- format(as.Date(trip_data$date), "%A")

colnames(tripdata_df) #to get the names of all the columns

Add a ride length (Duration) calculation to trip_data
tripdata_df$Duration <- difftime(tripdata_df$ended_at, tripdata_df$started_at)

str(tripdata_df) # to inspect the structure of the columns

Convert Duration from Factor to Numeric in order to run calculations
tripdata_df$Duration <- as.numeric(as.character(tripdata_df$Duration))
is.numeric(tripdata_df$Duration) # to confirm it is now numeric

Ride Distance wasn't used as a factor in this analysis as there could have been several stop off points and many journeys started and finished at the same 
start point... which would give a distance of zero ... 

but, if required in future ...

Add ride_distance calculation to tripdata_df
tripdata_df$ride_distance <- distGeo(matrix(c(tripdata_df$start_lng, tripdata_df$start_lat), ncol=2), matrix (c(tripdata_df$end_lng, 
tripdata_df$end_lat), ncol=2))
tripdata_df$ride_distance <- tripdata_df$ride_distance/1000 #distance in km

```{r Pre-cleanse summary}
#library(lubridate)
library(magrittr)
#library(dplyr)
#library(tidyverse)

Uncleansed_Summary <- tripdata_df %>%
  summarise(UnCleansed_Ride_Count = length(unique(tripdata_df$ride_id)),
    MissingStartStation_Count = length(which(is.na(tripdata_df$start_station_id))),
      MissingEndStation_Count = length(which(is.na(tripdata_df$end_station_id))),
      Start_GE_End_Count = length(which(tripdata_df$started_at >=
                                          tripdata_df$ended_at)))
Uncleansed_Summary
View(Uncleansed_Summary)
head(Uncleansed_Summary)

output_file <- paste(Output_Dir,"Uncleansed_Summary.csv", sep = "/")
# output_file
write.csv(Uncleansed_Summary, file= output_file,row.names = TRUE)

Uncleansed_Summary_df <- tripdata_df %>%
    filter(
      is.na(start_station_name) | 
      is.na(end_station_name)  | 
      started_at >= ended_at)

Uncleansed_Summary_df
View(Uncleansed_Summary_df)
head(Uncleansed_Summary_df)

Ride_Count = length(unique(Uncleansed_Summary_df$ride_id))
View(Ride_Count)

output_file <- paste(Output_Dir,"Uncleansed_Summary_Data.csv", sep = "/")
# output_file
write.csv(Uncleansed_Summary_df, file= output_file,row.names = TRUE)

grand_summary_df <- tripdata_df %>% 
  group_by(Month_Year = format(as.POSIXct(started_at, "%Y_%m"), "%Y_%m")) %>%
   drop_na() %>% 
    summarise(
      UnCleansed_Ride_Count = length(unique(ride_id)),
      Classic_Count = sum(rideable_type == "classic_bike"),
      Docked_Count = sum(rideable_type == "docked_bike"),
      Electric_Count = sum(rideable_type == "electric_bike"),
      Casual_Count = sum(member_casual == "casual"),
      Member_Count = sum(member_casual == "member"),
      Ride_Count = sum(Classic_Count + Docked_Count + Electric_Count),
      Duration_Min = min(round(difftime(ended_at, started_at, 
                                               units="mins"), digits = 0)),
      Duration_Mean = mean(round(difftime(ended_at, started_at, 
                                               units="mins"), digits = 0)),
      Duration_Max = max(round(difftime(ended_at, started_at, 
                                               units="mins"), digits = 0)),
      Duration_SD = sd(round(difftime(ended_at, started_at, 
                                           units="mins"), digits = 0)))      
View(grand_summary_df)     # view data
head(grand_summary_df)      # view top of dataset
colnames(grand_summary_df)  # view column names of dataset
str(grand_summary_df)       # see structure and record count of dataset

Ride_Count = count(grand_summary_df)
View(Ride_Count)

output_file <- paste(Output_Dir,"Uncleansed_Summary_Data.csv", sep = "/")
# output_file
write.csv(grand_summary_df, file= output_file,row.names = TRUE)
```

# Get overview summarys of trip info (after cleanse)

## Start Station not blank
## End Station not blank
## Start time before End time
## Sorted by Started At date/time

```{r Post-cleanse summary}
summary_df <- tripdata_df %>% 
    group_by(Month_Year = format(as.POSIXct(started_at,"%Y_%m"),"%Y_%m")) %>% 
    filter(start_station_name > "", 
         end_station_name > "", 
         started_at <= ended_at) %>%
    arrange(started_at)  %>% # sort by start date
    drop_na() %>% 
    summarise(
      Cleansed_Ride_Count = length(unique(ride_id)),
      Classic_Count = sum(rideable_type == "classic_bike"),
      Docked_Count = sum(rideable_type == "docked_bike"),
      Electric_Count = sum(rideable_type == "electric_bike"),
      Casual_Count = sum(member_casual == "casual"),
      Member_Count = sum(member_casual == "member"),
      Ride_Count = sum(Classic_Count + Docked_Count + Electric_Count),
      Duration_Min = min(round(difftime(ended_at, started_at, 
                                        units="mins"), digits = 0)),
      Duration_Mean = mean(round(difftime(ended_at, started_at, 
                                          units="mins"), digits = 0)),
      Duration_Max = max(round(difftime(ended_at, started_at, 
                                        units="mins"), digits = 0)),
      Duration_SD = sd(round(difftime(ended_at, started_at, 
                                      units="mins"), digits = 0)))

summary_count = count(summary_df)
View(summary_count)

View(summary_df)      # view data
head(summary_df)      # view top of dataset
colnames(summary_df)  # view column names of dataset
str(summary_df)       # see structure and record count of dataset

output_file <- paste(Output_Dir,"Trip_Summary_Cleansed.csv", sep = "/")
# output_file
write.csv(summary_df, file= output_file,row.names = TRUE)

summary_casual_df <- tripdata_df %>% 
  group_by(Month_Year = format(as.POSIXct(started_at, "%Y_%m"), "%Y_%m")) %>% 
  filter(start_station_name > "", 
         end_station_name > "", 
         started_at <= ended_at, 
         member_casual == "casual") %>%
  drop_na() %>% 
  summarise(
    Cleansed_Ride_Count = length(unique(ride_id)),
    Classic_Count = sum(rideable_type == "classic_bike"),
    Docked_Count = sum(rideable_type == "docked_bike"),
    Electric_Count = sum(rideable_type == "electric_bike"),
    Casual_Count = sum(member_casual == "casual"),
    Ride_Count = sum(Classic_Count + Docked_Count + Electric_Count),
    Duration_Min = min(round(difftime(ended_at, started_at, 
                                      units="mins"), digits = 0)),
    Duration_Mean = mean(round(difftime(ended_at, started_at, 
                                        units="mins"), digits = 0)),
    Duration_Max = max(round(difftime(ended_at, started_at, 
                                      units="mins"), digits = 0)),
    Duration_SD = sd(round(difftime(ended_at, started_at, 
                                    units="mins"), digits = 0)))

summary_casual_count = count(summary_casual_df)
View(summary_casual_count)

View(summary_casual_df)     # view data
head(summary_casual_df)     # view top of dataset
colnames(summary_casual_df) # view column names of dataset
str(summary_casual_df)      # see structure and record count of dataset

output_file <- paste(Output_Dir,"Trip_Summary_Casual_Cleansed.csv", sep = "/")
# output_file
write.csv(summary_casual_df, file= output_file,row.names = TRUE)

summary_member_df <- tripdata_df %>% 
  group_by(Month_Year = format(as.POSIXct(started_at, "%Y_%m"), "%Y_%m")) %>% 
  filter(start_station_name > "", 
         end_station_name > "", 
         started_at <= ended_at, 
         member_casual == "member") %>%
  drop_na() %>% 
  summarise(
    Classic_Count = sum(rideable_type == "classic_bike"),
    Docked_Count = sum(rideable_type == "docked_bike"),
    Electric_Count = sum(rideable_type == "electric_bike"),
    Member_Count = sum(member_casual == "member"),
    Ride_Count = sum(Classic_Count + Docked_Count + Electric_Count),
    Duration_Min = min(round(difftime(ended_at, started_at, 
                                      units="mins"), digits = 0)),
    Duration_Mean = mean(round(difftime(ended_at, started_at, 
                                        units="mins"), digits = 0)),
    Duration_Max = max(round(difftime(ended_at, started_at, 
                                      units="mins"), digits = 0)),
    Duration_SD = sd(round(difftime(ended_at, started_at, 
                                    units="mins"), digits = 0)))

summary_member_count = count(summary_member_df)
View(summary_member_count)

View(summary_member_df)     # view data
head(summary_member_df)     # view top of dataset
colnames(summary_member_df) # view column names of dataset
str(summary_member_df)      # see structure and record count of dataset

output_file <- paste(Output_Dir,"Trip_Summary_Member_Cleansed.csv", sep = "/")
# output_file
write.csv(summary_member_df, file= output_file,row.names = TRUE)
```

# Summarise and Filter

## Start Station not blank
## End Station not blank
## Start time before End time
## Sorted by Started At Date/Time

```{r summarize and filter}
# Apply a filter() to dataset to drop data with missing start or end station 
filtered_tripdata_df <- tripdata_df %>%
  filter(start_station_name > "", 
         end_station_name > "", 
         started_at <= ended_at) %>%
  drop_na() %>% 
  arrange(started_at)  # sort by start date

filtered_tripdata_count = count(filtered_tripdata_df)
View(filtered_tripdata_count)

colnames(filtered_tripdata_df)
head(filtered_tripdata_df)
str(filtered_tripdata_df)   # see structure and record count of dataset
```

# Manipulate dataset, create calculated fields and dataframes

```{r Clean_CSV}
#library(lubridate)
#library(magrittr)
#library(dplyr)
#library(tidyverse)

clean_tripdata_df <- mutate(filtered_tripdata_df, 
                    datetimenow = Sys.time(),
                    hour_start = hour(as.POSIXct(started_at)), 
                    datetime_start = as.POSIXct(started_at, 
                                            format = "%m/%d/%Y %H:%M:%S"),
                    datetime_end = as.POSIXct(ended_at, 
                                            format = "%m/%d/%Y %H:%M:%S"),
    day_long = weekdays(as.POSIXct(started_at)),
    day_short = weekdays(as.POSIXct(started_at), abbreviate = TRUE),
                    month_long = months.Date(as.POSIXct(started_at)),
                    month_short = months.Date(as.POSIXct(started_at),
                                              abbreviate = TRUE),
                    yearnow = year(as.POSIXct(started_at)),
                    yyyy_mm = format(as.Date(started_at, "%Y_%m"), "%Y_%m"), 
                    duration_rounded = round(difftime(ended_at, started_at, 
                                               units="mins"), digits = 0),
                    duration_secs = round(difftime(ended_at, started_at), 
                                           digits = 0),
                    duration_roundup = ceiling(difftime(ended_at, started_at,
                                               units="mins")),
                    duration_rounddown = floor(difftime(ended_at, started_at,
                                               units="mins")),
                    duration_trunc = trunc(difftime(ended_at, started_at, 
                                               units="mins")),
                    state_name = "Illinois",
                    city_name = "Chicago"
                    )

clean_tripdata_count = count(clean_tripdata_df)
View(clean_tripdata_count)

colnames(clean_tripdata_df) 
head(clean_tripdata_df)
str(clean_tripdata_df)       # see structure and record count of dataset
```

# Sub-set of clean data for display 

## Duration > 0 

```{r Subset_Clean_CSV}
#library(lubridate)
#library(magrittr)
#library(dplyr)
#library(tidyverse)

subset_df <- clean_tripdata_df %>% 
    drop_na() %>% 
    select(Ride_Id = ride_id, 
         Ride_Type = rideable_type,
         Started = started_at, 
         Ended = ended_at,
         Start_Station = start_station_name,
         End_Station = end_station_name, 
         Member_Type = member_casual, 
         Start_Lat = start_lat,
         Start_Lng = start_lng,         
         End_Lat = end_lat,         
         End_Lng = end_lng,         
         WeekDay = day_long, 
         Year_Month = yyyy_mm,
         Duration = duration_rounded,
         Hour_Start = hour_start,
         State = state_name,
         City = city_name)  %>%
  filter(Duration > 0)

subset_count = length(unique(subset_df$Ride_Id))
View(subset_count)
head(subset_count)

colnames(subset_df) 
head(subset_df)
str(subset_df)       # see structure and record count of dataset
```

# Store data list of Casuals with trip duration >= 30 for mail shot survey

Lookup key for backward compatibility is Ride_Id

File = Casual_Over30.csv

```{r Capture Survey data}
#library(lubridate)
#library(magrittr)
#library(dplyr)
#library(tidyverse)

colnames(subset_df) 
#View(subset_df)
head(subset_df)

Casual_Over30_df <- subset_df %>%
  filter(subset_df$Member_Type == "casual" & subset_df$Duration >= 30)
nrow(Casual_Over30_df)
#View(Casual_Over30_df)
head(Casual_Over30_df)

output_file <- paste(Output_Dir,"Casual_Over30.csv", sep = "/")
# output_file
write.csv(Casual_Over30_df, file= output_file,row.names = TRUE)
```

# Get specific averages

## Descriptive analysis on Ride length Durations

## mean    = straight average (total ride length duration / total rides)
## max     = longest ride duration
## min     = shortest (acceptable) ride duration 

```{r Capture Averages}
# if there are group_by problems with dplyr, then try detaching plyr
# library(plyr)
# detach(package:plyr)

#library(dplyr)
#library(tidyverse)
#library(lubridate)
#library(magrittr)

colnames(subset_df) 
head(subset_df)
# subset_count = length(unique(subset_df$Ride_Id))
# View(subset_count)
#head(subset_count)

averages_df <- subset_df %>%
  group_by(Member_Type, Ride_Type) %>%
  drop_na() %>%
  summarise(Ride_Count = length(unique(Ride_Id)),
        Min_Duration = min(Duration),
        Mean_Duration = round(mean(Duration),digits = 0),
        Max_Duration = round(max(Duration),digits = 0))
#View(averages_df)
head(averages_df)

#averages_df_count = count(averages_df)
#View(averages_df_count)
#head(averages_df_count)
  
output_file <- paste(Output_Dir,"averages_df.csv", sep = "/")
# output_file
write.csv(averages_df, file= output_file,row.names = TRUE)

averages_yyyymm_df <- subset_df %>%
  group_by(Year_Month, Member_Type, Ride_Type) %>%
  drop_na() %>%
  summarise(Ride_Count = length(unique(Ride_Id)),
        Min_Duration = min(Duration),
        Mean_Duration = round(mean(Duration),digits = 0),
        Max_Duration = round(max(Duration),digits = 0))
#View(averages_yyyymm_df)
head(averages_yyyymm_df)

#averages_yyyymm_df_count = count(averages_yyyymm_df)
#View(averages_yyyymm_df_count)
#head(averages_yyyymm_df_count)

output_file <- paste(Output_Dir,"averages_yyyymm_df.csv", sep = "/")
# output_file
write.csv(averages_yyyymm_df, file= output_file,row.names = TRUE)

```

# Capture Outliers / Rogues

## Duration >= 1000 minutes

File = Top_Outliers_tripdata.csv

```{r Capture Outliers}
Count_Duration_GE_1000 <- sum(subset_df$Duration >= 1000)
Count_Duration_GE_1000

big_duration_df <- subset_df %>%
  filter(Duration >= 1000) %>%
  drop_na() %>% 
  arrange(-Duration) 

#View(big_duration_df)  # show records >= 1000 minutes duration
head(big_duration_df)  # show records >= 1000 minutes duration

big_duration_df

output_file <- paste(Output_Dir,"Top_Outliers_tripdata.csv", sep = "/")
# output_file
write.csv(big_duration_df, file= output_file,row.names = TRUE)
```

# Filters and sums

What is standard deviation? Standard deviation tells you how spread out the 
data is. It is a measure of how far each observed value is from the mean. 
In any distribution, about 95 % of values will be within 2 standard deviations of the mean

```{r Summarise data}
colnames(subset_df)
subset_df %>%    # pass data into 
  group_by(WeekDay) %>%     # pass “grouped data” into 
  drop_na() %>%             # drop any “null’s” and pass rest of data into
  summarise(min_duration = min(Duration), 
            mean_duration = mean(Duration),
            max_duration = max(Duration))   # and the MEAN data

# Use the summarize() and sd() functions to find 
# the standard deviation of the ride duration
sd_duration <- subset_df %>%
  summarise(sd(Duration))

sd_duration
```


# Include Plots

## Ride types and frequencies

Use the geom_bar() function to create a bar chart 
with the variable Company.Location on the x-axis

```{r Bar chart1}
# Use the geom_bar() function to create a bar chart 
# with the variable WeekDay on the x-axis
#library(ggplot2)       # load required library

subset_df %>%
  group_by(Member_Type, WeekDay) %>% 
  arrange(Member_Type, WeekDay) %>% 
  ggplot() +
  geom_bar(mapping = aes(x= factor(WeekDay, levels = c("Monday", "Tuesday",
              "Wednesday", "Thursday", "Friday", "Saturday", "Sunday")),
              fill=Member_Type)) +
  theme(axis.text.x = element_text(angle = 45)) +
  scale_y_continuous(labels = function(x) format(x, scientific = FALSE)) +
  facet_wrap(~Ride_Type) +
  labs(title = "Ride types and frequencies", 
       caption="Graph by: Coyne Operations Ltd 2022", 
       subtitle="Data Range: Jun-2021 to May-2022, data provided by Motivate International Inc.", 
       x = "Day of Week",
       y = "Count") 

# Save chart to working directory 
setwd(Output_Dir)
ggsave("Ride types and frequencies.jpg")

```

## Ride types and frequencies by Year/Month

```{r Bar chart2}
# Use the geom_bar() function to create a bar chart 
# with the variable Day on the x-axis
#library(ggplot2)       # load required library

subset_df %>%
  ggplot() +
  geom_bar(mapping = aes(x= factor(WeekDay, levels = c("Monday", "Tuesday",
              "Wednesday", "Thursday", "Friday", "Saturday", "Sunday")),
              fill=Member_Type)) +
    theme(axis.text.x = element_text(angle = 45)) +
  scale_y_continuous(labels = function(x) format(x, scientific = FALSE)) +
  facet_wrap(~Year_Month) +
  labs(title = "Ride types and frequencies by Year/Month", 
       caption="Graph by: Coyne Operations Ltd 2022", 
       subtitle="Data Range: Jun-2021 to May-2022, data provided by Motivate International Inc.", 
       x = "Day of Week",
       y = "Count")

# Save chart to working directory 
setwd(Output_Dir)
ggsave("Ride types and frequencies by Year Month.jpg")

```

## Trips by Ride Type per Hour of Day

```{r Bar chart3}
# Use the geom_bar() function to create a bar chart 
# with the variable WeekDay on the x-axis
#library(ggplot2)       # load required library

subset_df %>%
  ggplot() +
  geom_bar(mapping = aes(x = Hour_Start, fill=Member_Type)) +
  theme(axis.text.x = element_text(angle = 45)) +
  scale_y_continuous(labels = function(x) format(x, scientific = FALSE)) +
  facet_wrap(~Ride_Type) +
  labs(title = "Ride types and frequencies by Hour", 
       caption="Graph by: Coyne Operations Ltd 2022", 
       subtitle="Data Range: Jun-2021 to May-2022, data provided by Motivate International Inc.", 
       x = "Hour of Day",
       y = "Count")

# Save chart to working directory 
setwd(Output_Dir)
ggsave("Ride types and frequencies by hour.jpg")
```

## Trips by Ride Type per Day

```{r Bar chart4}
#library(ggplot2)       # load required library

subset_df %>%
  ggplot() +
  geom_bar(mapping = aes(x= factor(WeekDay, levels = c("Monday", "Tuesday",
              "Wednesday", "Thursday", "Friday", "Saturday", "Sunday")),
              fill=Member_Type)) +
  scale_y_continuous(labels = function(x) format(x, scientific = FALSE)) +
  facet_wrap(~Ride_Type) +
  theme(axis.text.x = element_text(angle = 45)) +
  labs(title = "Trips by Ride Type per Day", 
       caption="Graph by: Coyne Operations Ltd 2022", 
       subtitle="Data Range: Jun-2021 to May-2022, data provided by Motivate International Inc.", 
       x = "Day of Week",
       y = "Count") 

# Save chart to working directory 
setwd(Output_Dir)
ggsave("Trips by Ride Type per Day.jpg")

```

## Trips by Member Type per Day

```{r Bar chart5}
#library(ggplot2)       # load required library

subset_df %>%
  ggplot() +
  geom_bar(mapping = aes(x= factor(WeekDay, levels = c("Monday", "Tuesday",
              "Wednesday", "Thursday", "Friday", "Saturday", "Sunday")),
              fill=Member_Type)) +
  scale_y_continuous(labels = function(x) format(x, scientific = FALSE)) +
  facet_wrap(~Member_Type) +
  theme(axis.text.x = element_text(angle = 45)) +
  labs(title = "Trips by Member Type per Day", 
       caption="Graph by: Coyne Operations Ltd 2022", 
       subtitle="Data Range: Jun-2021 to May-2022, data provided by Motivate International Inc.", 
       x = "Day of Week",
       y = "Count") 

# Save chart to working directory 
setwd(Output_Dir)
ggsave("Trips by Member Type per Day.jpg")

```


# Line charts 

## Rides by Member Type per Month

```{r Line chart1}
# Line chart 1
#library(dplyr)
#library(tidyverse)
#library(ggplot2)       # load required library

colnames(grand_summary_df)

chart_data <- data.frame(MmmYYYY = grand_summary_df$Month_Year,
                         Classic = grand_summary_df$Classic_Count,
                         Docked = grand_summary_df$Docked_Count,
                         Electric = grand_summary_df$Electric_Count,
                         Casual = grand_summary_df$Casual_Count,
                         Member = grand_summary_df$Member_Count
                         ) %>%
              group_by(MmmYYYY)
head(chart_data)                         
nrow(chart_data)

output_file <- paste(Output_Dir,"chartdata_tripdata.csv", sep = "/")
# output_file
write.csv(chart_data, file= output_file,row.names = TRUE)

chart_data %>%
  ggplot(aes(x=MmmYYYY)) + 
  geom_line(aes(y = Member, group=1, colour="Member")) + # ensure color in aes
  geom_line(aes(y = Casual, group=2, colour="Casual")) + # ensure color in aes
  theme(axis.text.x = element_text(angle = 45)) +
  scale_y_continuous(labels = function(x) format(x, scientific = FALSE)) +
#  facet_wrap(~Ride_Type) +
  labs(title = "Rides by Member Type per Month", 
       caption="Graph by: Coyne Operations Ltd 2022", 
       subtitle="Data Range: Jun-2021 to May-2022, data provided by Motivate International Inc.") 

# Save chart to working directory 
setwd(Output_Dir)
ggsave("Rides by Member Type per Month.jpg")
```

## Trips by Ride Type per Month

```{r Line chart2}
# Line chart 2
#library(plotly)
library(ggplot2)       # load required library

ggplot(data=chart_data, aes(x=MmmYYYY)) + 
  geom_line(aes(y = Classic, group=1, colour="Classic")) + # color in aes
  geom_line(aes(y = Docked, group=2, colour="Docked")) + # color in aes
  geom_line(aes(y = Electric, group=3, colour="Electric")) + # color in aes
  theme(axis.text.x = element_text(angle = 45)) +
  scale_y_continuous(labels = function(x) format(x, scientific = FALSE)) +
#  facet_wrap(~Ride_Type) +
  labs(title = "Trips by Ride Type per Month", 
       caption="Graph by: Coyne Operations Ltd 2022", 
       subtitle="Data Range: Jun-2021 to May-2022, data provided by Motivate International Inc.") 

# Save chart to working directory 
setwd(Output_Dir)
ggsave("Trips by Ride Type per Month.jpg")
```


# Top ten rankings

## Top 10 Start Locations

```{r Rankings_Top10_Starts}
# get count of starts and ends for each station
# Top 10 Start Stations
station_starts <- as.data.frame(table(subset_df$Start_Station)) %>% 
  drop_na() %>% 
  arrange(-Freq) # use "-" sign to sort DESC
top10_starts <- station_starts[1:10,]

top10_starts
View(top10_starts)
head(top10_starts)

output_file <- paste(Output_Dir,"Top10_Start_tripdata.csv", sep = "/")
# output_file
write.csv(top10_starts, file= output_file,row.names = TRUE)
```

## Top 10 End Locations

```{r Rankings_Top10_Ends}
# Top 10 End Stations

station_ends <- as.data.frame(table(subset_df$End_Station)) %>% 
  drop_na() %>% 
  arrange(-Freq) # use "-" sign to sort DESC
top10_ends <- station_ends[1:10,]

top10_ends
View(top10_ends)
head(top10_ends)

output_file <- paste(Output_Dir,"Top10_End_tripdata.csv", sep = "/")
# output_file
write.csv(top10_ends, file= output_file,row.names = TRUE)
```

## Top 10 Journeys

```{r Rankings_Top10_Journeys}
# Top 10 Journeys

temp <- unite(subset_df,"Journey",Start_Station, 
              End_Station, sep = " to ") %>%
    drop_na()

temp2 <- table(temp %>% 
                 drop_na() %>% 
                 select(Journey))

temp3 <- as.data.frame(temp2) %>%
  arrange(-Freq) # use "-" sign to sort DESC
Top10_Journeys <- temp3[1:10,]

Top10_Journeys
View(Top10_Journeys)
head(Top10_Journeys)

output_file <- paste(Output_Dir,"Top10_Journeys_tripdata.csv", sep = "/")
# output_file
write.csv(Top10_Journeys, file= output_file,row.names = TRUE)
```

## Top 10 Durations in Minutes

File = Top10_Durations_tripdata.csv

```{r Rankings_Top10_Durations}
# Top 10 Durations
colnames(subset_df)
temp <- as.data.frame(subset_df %>% 
                        select(Ride_Id, Ride_Type, Member_Type, Duration,
                               Started, Ended) %>% 
            arrange(-Duration)) # use "-" sign to sort DESC
#temp

Top10_Durations <- temp[1:10,]

Top10_Durations
View(Top10_Durations)
head(Top10_Durations)

output_file <- paste(Output_Dir,"Top10_Durations_tripdata.csv", sep = "/")
# output_file
write.csv(Top10_Durations, file= output_file,row.names = TRUE)
```

# Thank you for your attention, any feedback will be gratefully received

# Colin Coyne
# Coyne Operations Ltd
# coyneops@gmail.com

